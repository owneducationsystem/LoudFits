<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin WebSocket Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }
    .status.connected {
      background-color: #d1fae5;
      color: #047857;
    }
    .status.disconnected {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    .events-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 10px;
    }
    .event-item {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    .event-item:last-child {
      border-bottom: none;
    }
    .event-type {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .event-data {
      font-family: monospace;
      background-color: #f3f4f6;
      padding: 8px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .button {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .button:hover {
      background-color: #4338ca;
    }
  </style>
</head>
<body>
  <h1>Admin WebSocket Test</h1>
  
  <div class="card">
    <div class="header">
      <h2>Connection Status</h2>
      <span id="connection-status" class="status disconnected">Disconnected</span>
    </div>
    <p>Admin ID: <strong id="admin-id">Not registered</strong></p>
    <button id="connect-btn" class="button">Connect</button>
    <button id="disconnect-btn" class="button" style="background-color: #dc2626;">Disconnect</button>
  </div>
  
  <div class="card">
    <div class="header">
      <h2>Send Event</h2>
    </div>
    <div style="margin-bottom: 15px;">
      <label for="event-type">Event Type:</label>
      <select id="event-type" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 100%;">
        <option value="order_update">Order Update</option>
        <option value="user_signup">User Signup</option>
        <option value="product_update">Product Update</option>
        <option value="stock_alert">Stock Alert</option>
      </select>
    </div>
    <div style="margin-bottom: 15px;">
      <label for="event-data">Event Data (JSON):</label>
      <textarea id="event-data" rows="4" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 100%; font-family: monospace;">{
  "id": 123,
  "message": "Test event",
  "timestamp": "2025-05-12T12:00:00Z"
}</textarea>
    </div>
    <button id="send-event-btn" class="button">Send Event</button>
  </div>
  
  <div class="card">
    <div class="header">
      <h2>Received Events</h2>
      <button id="clear-events-btn" class="button" style="background-color: #6b7280;">Clear</button>
    </div>
    <div id="events-container" class="events-container">
      <div class="event-item">
        <div class="event-type">Welcome</div>
        <div class="event-data">Connect to start receiving events</div>
      </div>
    </div>
  </div>

  <script>
    // Connection elements
    const connectionStatus = document.getElementById('connection-status');
    const adminIdElement = document.getElementById('admin-id');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    
    // Event elements
    const eventTypeSelect = document.getElementById('event-type');
    const eventDataTextarea = document.getElementById('event-data');
    const sendEventBtn = document.getElementById('send-event-btn');
    const eventsContainer = document.getElementById('events-container');
    const clearEventsBtn = document.getElementById('clear-events-btn');
    
    // WebSocket variables
    let socket = null;
    let adminId = 1; // Default admin ID
    
    // Connect to WebSocket
    function connect() {
      // Close previous connection if any
      if (socket) {
        socket.close();
      }
      
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;
      
      socket = new WebSocket(wsUrl);
      
      socket.onopen = () => {
        connectionStatus.textContent = 'Connected';
        connectionStatus.classList.remove('disconnected');
        connectionStatus.classList.add('connected');
        
        // Register as admin
        const registerMessage = {
          type: 'register',
          role: 'admin',
          adminId: adminId
        };
        socket.send(JSON.stringify(registerMessage));
        
        addEventToList({
          type: 'connection',
          data: 'Connected to WebSocket server'
        });
      };
      
      socket.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          
          if (message.type === 'registered') {
            adminIdElement.textContent = message.adminId;
            addEventToList({
              type: 'registration',
              data: `Registered as Admin ID: ${message.adminId}`
            });
          } else {
            addEventToList(message);
          }
        } catch (error) {
          console.error('Error parsing message:', error);
          addEventToList({
            type: 'error',
            data: `Failed to parse message: ${event.data}`
          });
        }
      };
      
      socket.onclose = () => {
        connectionStatus.textContent = 'Disconnected';
        connectionStatus.classList.remove('connected');
        connectionStatus.classList.add('disconnected');
        adminIdElement.textContent = 'Not registered';
        
        addEventToList({
          type: 'connection',
          data: 'Disconnected from WebSocket server'
        });
      };
      
      socket.onerror = (error) => {
        console.error('WebSocket error:', error);
        addEventToList({
          type: 'error',
          data: 'WebSocket connection error'
        });
      };
    }
    
    // Disconnect from WebSocket
    function disconnect() {
      if (socket) {
        socket.close();
      }
    }
    
    // Send event via REST API
    async function sendEvent() {
      try {
        const eventType = eventTypeSelect.value;
        const eventData = JSON.parse(eventDataTextarea.value);
        
        const response = await fetch('/api/admin/events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Admin-ID': adminId.toString(),
          },
          body: JSON.stringify({
            event: eventType,
            data: eventData
          })
        });
        
        const result = await response.json();
        console.log('Event sent:', result);
        
        addEventToList({
          type: 'sent_event',
          data: {
            event: eventType,
            data: eventData,
            result: result
          }
        });
      } catch (error) {
        console.error('Error sending event:', error);
        addEventToList({
          type: 'error',
          data: `Failed to send event: ${error.message}`
        });
      }
    }
    
    // Add event to the events list
    function addEventToList(event) {
      const eventItem = document.createElement('div');
      eventItem.className = 'event-item';
      
      const eventTypeElement = document.createElement('div');
      eventTypeElement.className = 'event-type';
      eventTypeElement.textContent = event.type;
      
      const eventDataElement = document.createElement('div');
      eventDataElement.className = 'event-data';
      
      if (typeof event.data === 'object') {
        eventDataElement.textContent = JSON.stringify(event.data, null, 2);
      } else {
        eventDataElement.textContent = event.data;
      }
      
      eventItem.appendChild(eventTypeElement);
      eventItem.appendChild(eventDataElement);
      
      eventsContainer.appendChild(eventItem);
      eventsContainer.scrollTop = eventsContainer.scrollHeight;
    }
    
    // Clear events list
    function clearEvents() {
      eventsContainer.innerHTML = '';
    }
    
    // Event listeners
    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);
    sendEventBtn.addEventListener('click', sendEvent);
    clearEventsBtn.addEventListener('click', clearEvents);
    
    // Auto-connect on page load
    window.addEventListener('load', connect);
  </script>
</body>
</html>